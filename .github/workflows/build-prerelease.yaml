name: Build Prerelease

on:
  workflow_dispatch:
    inputs:
      android:
        description: 'Build Android'
        required: false
        type: boolean
        default: true
      windows:
        description: 'Build Windows'
        required: false
        type: boolean
        default: true
      linux:
        description: 'Build Linux'
        required: false
        type: boolean
        default: true

jobs:
  build-android:
    if: ${{ inputs.android == true }}
    uses: ./.github/workflows/build-android.yaml
    permissions: write-all
    with:
      ref: ${{ github.ref_name }}

  build-windows:
    if: ${{ inputs.windows == true }}
    uses: ./.github/workflows/build-windows.yaml
    permissions: write-all
    with:
      ref: ${{ github.ref_name }}

  build-linux:
    if: ${{ inputs.linux == true }}
    uses: ./.github/workflows/build-linux.yaml
    permissions: write-all
    with:
      ref: ${{ github.ref_name }}

  upload-to-gcp:
    needs: [build-android, build-windows, build-linux]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP using Service Account Key
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload Android artifacts
        if: ${{ needs.build-android.result == 'success' }}
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: artifacts/android-outputs/
          destination:  ${{ secrets.GCS_BUCKET_NAME }}/artifacts/prerelease/android/
          predefinedAcl: publicRead

      - name: Android upload confirmation
        if: ${{ needs.build-android.result == 'success' }}
        run: |
          echo "Successfully uploaded Android artifacts to https://storage.googleapis.com/${{ secrets.GCS_BUCKET_NAME }}/artifacts/prerelease/android/"

      - name: Create Windows zip archive
        if: ${{ needs.build-windows.result == 'success' }}
        run: |
          cd artifacts/windows-outputs/
          zip -r ../../windows-artifacts.zip .
          cd ../..

      - name: Upload Windows artifacts
        if: ${{ needs.build-windows.result == 'success' }}
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: windows-artifacts.zip
          destination: ${{ secrets.GCS_BUCKET_NAME }}/artifacts/prerelease/windows.zip
          predefinedAcl: publicRead

      - name: Windows upload confirmation
        if: ${{ needs.build-windows.result == 'success' }}
        run: |
          echo "Successfully uploaded Windows artifacts to https://storage.googleapis.com/${{ secrets.GCS_BUCKET_NAME }}/artifacts/prerelease/windows.zip"

      - name: Create Linux tar.gz archive
        if: ${{ needs.build-linux.result == 'success' }}
        run: |
          cd artifacts/linux-outputs/
          tar -czf ../../linux-artifacts.tar.gz .
          cd ../..

      - name: Upload Linux artifacts
        if: ${{ needs.build-linux.result == 'success' }}
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: linux-artifacts.tar.gz
          destination: ${{ secrets.GCS_BUCKET_NAME }}/artifacts/prerelease/linux.tar.gz
          predefinedAcl: publicRead

      - name: Linux upload confirmation
        if: ${{ needs.build-linux.result == 'success' }}
        run: |
          echo "Successfully uploaded Linux artifacts to https://storage.googleapis.com/${{ secrets.GCS_BUCKET_NAME }}/artifacts/prerelease/linux.tar.gz"
